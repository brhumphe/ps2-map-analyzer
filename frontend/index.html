<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map View</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="" language="JavaScript"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const yx = L.latLng;

    const xy = function (x, y) {
        if (Array.isArray(x)) {    // When doing xy([x, y]);
            return yx(x[1], x[0]);
        }
        return yx(y, x);  // When doing xy(x, y);
    };

    const game_to_latLng = function (x, y) {
        const rad = 90 * Math.PI / 180;
        return xy(x * Math.cos(rad) - y * Math.sin(rad),
            x * Math.sin(rad) + y * Math.cos(rad) - 256);
    }

    const latLng_to_game = function (latLng) {
        const rad = -90 * Math.PI / 180;
        return [latLng.lng * Math.cos(rad) - latLng.lat * Math.sin(rad) + 256,
            latLng.lng * Math.sin(rad) + latLng.lat * Math.cos(rad)];
    }

    // Add cursor coordinates in a popup that follows the mouse
    L.CursorHandler = L.Handler.extend({

        addHooks: function () {
            this._popup = new L.Popup();
            this._map.on('mouseover', this._open, this);
            this._map.on('mousemove', this._update, this);
            this._map.on('mouseout', this._close, this);
        },

        removeHooks: function () {
            this._map.off('mouseover', this._open, this);
            this._map.off('mousemove', this._update, this);
            this._map.off('mouseout', this._close, this);
        },

        _open: function (e) {
            this._update(e);
            this._popup.openOn(this._map);
        },

        _close: function () {
            this._map.closePopup(this._popup);
        },

        _update: function (e) {
            const coords = latLng_to_game(e.latlng);
            this._popup.setLatLng(e.latlng)
                .setContent(`[${coords[0].toFixed(0)}, ${coords[1].toFixed(0)}]`);
        }


    });

    L.Map.addInitHook('addHandler', 'cursor', L.CursorHandler);

    // Map creation
    const map = L.map('map', {
        crs: L.CRS.Simple,
        center: [0, 0],
        zoom: -20,
        cursor: true,
    }).setView([0, 0], 0);
    // Create custom tile layer
    const customTileLayer = L.tileLayer('', {
        zoomSnap: 1,
        minZoom: -20,
        maxZoom: 3,
        tileSize: 256,
        minNativeZoom: 0,
        maxNativeZoom: 0,
        noWrap: true,
        attribution: 'Indar Map',
        bounds: [[-4096, -4096], [4096, 4096]],
    });

    // Override the tile URL creation
    customTileLayer.getTileUrl = function (coords) {
        const z = coords.z;
        // Transform Leaflet coordinates to your coordinate system
        // Leaflet gives 0,1,2,3... but you need 0,4,8,12... (increment by 4)
        const gameX = coords.x * 4;
        const gameY = -coords.y * 4;

        // Format as 3-digit zero-padded strings
        let xStr = Math.abs(gameX).toString().padStart(3, '0');
        let yStr = Math.abs(gameY).toString().padStart(3, '0');

        // Handle negative coordinates
        if (gameX < 0) xStr = '-' + Math.abs(gameX).toString().padStart(2, '0');
        if (gameY < 0) yStr = '-' + Math.abs(gameY).toString().padStart(2, '0');

        return `tiles/indar/Indar_Tile_${xStr}_${yStr}_LOD${z}.png`;
    };

    // Add to map
    customTileLayer.addTo(map);
    const west_wg = game_to_latLng(-2276.637, 2486.449)
    const east_wg = game_to_latLng(-2435.838, -2764.692)
    const north_wg = game_to_latLng(2750.148, -95.01959)
    L.marker(west_wg).addTo(map).bindPopup("West Gate [-2276.637, 2486.449]")
    L.marker(east_wg).addTo(map).bindPopup("East Gate [-2435.838, -2764.692]")
    L.marker(north_wg).addTo(map).bindPopup("North Gate [2750.148, -95.01959]")
</script>
</body>
</html>